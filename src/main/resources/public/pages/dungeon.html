<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>

    <script>
        var stage;
        var container;

        var map;

        var images = {};
        var preload;
        var manifest = [
            {src: 'x.png', id: 'x', x: 5, y: 5},
            {src: 'blank.png', id: 'blank', x: 5, y: 5},
            {src: 'backing.png', id: 'backing', x: 5, y: 5},
            {src: 'icon.png', id: 'icon', x: 5, y: 5}
        ];

        var offset = {x:null, y:null};     // vector from mouse point to corner of container
        var allowHorizontalMove;
        var allowVerticalMove;

        var movingIcon;

        function init() {
            stage = new createjs.Stage("demoCanvas");
            stage.setBounds(0, 0, stage.canvas.getAttribute('width'), stage.canvas.getAttribute('height'));
            stage.mouseMoveOutside = true;

            console.log('stage bounds '+ stage.getBounds());

            container = new createjs.Container();
            stage.addChild(container);
            container.addEventListener('mousedown', function(event) {
                if (event.nativeEvent.button != 2) {        // restrict to right button
                    return;
                }

                offset = {x: event.target.parent.x - event.rawX,
                          y: event.target.parent.y - event.rawY };
                console.log(offset);
            });
            container.addEventListener('pressmove', function(event) {
                if (event.nativeEvent.button != 2) {        // restrict to right button
                    return;
                }

                //console.log('container pressmove');
                if (allowHorizontalMove) {
                    container.x = event.rawX + offset.x;
                }
                if (allowVerticalMove) {
                    container.y = event.rawY + offset.y;
                }

                var stageRectangle = stage.getTransformedBounds();
                var contRectangle = container.getTransformedBounds();

                if (!contRectangle.contains(stageRectangle.x, stageRectangle.y, stageRectangle.width, stageRectangle.height)) {
                    //console.log('OUT ' + 'stageRect ' + stageRectangle + ' containerRect ' + contRectangle);
                    // adjust
                    if (allowHorizontalMove) {
                        if (contRectangle.x > stageRectangle.x) {
                            container.x = stageRectangle.x;
                        }
                        if (contRectangle.x + contRectangle.width < stageRectangle.width) {
                            container.x = stageRectangle.width - contRectangle.width;
                        }
                    }

                    if (allowVerticalMove) {
                        if (contRectangle.y > stageRectangle.y) {
                            container.y = stageRectangle.y;
                        }
                        if (contRectangle.y + contRectangle.height < stageRectangle.height) {
                            container.y = stageRectangle.height - contRectangle.height;
                        }
                    }
                }
            });

            createjs.Ticker.setFPS(60);
            createjs.Ticker.addEventListener("tick", stage);

            loadImage();
        }

        function loadImage() {
            preload = new createjs.LoadQueue();
            preload.addEventListener("fileload", handleFileComplete);
            preload.addEventListener("complete", handleComplete);
            preload.loadManifest(manifest);
        }

        function handleFileComplete(event) {
            console.log(event.item);
        }

        function handleComplete() {
            loadMap();
        }

        function instantiateImage(imgId) {
            var image = preload.getResult(imgId);

            // instantiate a bitmap based on this image
            var bitmap = new createjs.Bitmap(image);
            return bitmap;
        }

        function loadMap() {
            // build test map
            map = [];
            for (i=0; i<5; i++) {
                inner = [];
                for (j=0; j<5; j++) {
                    if (j%2 == 0) {
                        inner.push(1);
                    }
                    else {
                        inner.push(0);
                    }
                }
                map.push(inner);
            }

            x = 0;
            y = 0;
            for (col=0; col<map.length; col++) {
                for (row=0; row<map[col].length; row++) {
                    var bitmap;
                    var backing;
                    if (map[col][row] == 1) {
                        bitmap = instantiateImage('x');
                    }
                    else {
                        bitmap = instantiateImage('blank');
                    }
                    bitmap.x = x;
                    bitmap.y = y;
                    bitmap.data = {coordCol: col, coordRow: row}
                    bitmap.addEventListener('click', function(event) {
                        if (event.nativeEvent.button != 0) {        // only left click
                            return;
                        }
                        console.log('bitmap click');
                        x = event.target.data.coordCol;
                        y = event.target.data.coordRow;

                        createjs.Tween.get(event.target).to({x:1, y:1}, 1000).call(function() {
                            //Tween complete
                        });

                    });
                    container.addChild(bitmap);

                    if (col == 2 && row == 2) {
                        iconBitmap = instantiateImage('icon');
                        iconBitmap.x = x;
                        iconBitmap.y = y;
                        container.addChild(iconBitmap);

                        movingIcon = iconBitmap;
                    }

                    backing = instantiateImage('backing');
                    bitmap.hitArea = backing;

                    y += 10;
                }
                x+= 10;
                y = 0;
            }

            console.log('container bounds ' + container.getBounds());

            var stageRectangle = stage.getTransformedBounds();
            var contRectangle = container.getTransformedBounds();
            allowHorizontalMove = contRectangle.width > stageRectangle.width;
            allowVerticalMove = contRectangle.height > stageRectangle.height;

            // center the grid
            if (!allowHorizontalMove) {     // need to center horizontally
                container.x = (stageRectangle.width - contRectangle.width) / 2;
            }
            if (!allowVerticalMove) {       // // need to center vertically
                container.y = (stageRectangle.height - contRectangle.height) / 2;
            }

        }

    </script>
</head>
<body onload="init();">

<canvas id="demoCanvas" width="35" height="100"
        style="margin-left:100px; margin-top:100px; border: 1px solid #ccc"
        oncontextmenu="return false;"></canvas>

</body>
</html>